@page "/pending-requests"
@using System.Security.Claims
@using Blazorise.Extensions
@using Hangfire
@using Humanizer
@using NBitcoin
@attribute [Authorize(Roles = "FinanceManager, Superadmin, NodeManager")]

<PageTitle>Channel Operation Requests</PageTitle>

@if (!_hidePendingRequests)
{
    <h3>Requests awaiting my signature</h3>
    <br />
    <DataGrid TItem="ChannelOperationRequest"
              Data="@_channelRequests"
              CustomFilter="@RequestPendingFilter"
              ShowPager="true"
              ShowPageSizes="true"
              Editable="true"
              Striped="true">
        <ChildContent>
            <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.Id)" Caption="#" Sortable="false" Displayable="true"/>
            <DataGridColumn TItem="ChannelOperationRequest" Field="SourceNode.Name" Caption="Source Node" Sortable="false" Displayable="true"/>
            <DataGridColumn TItem="ChannelOperationRequest" Field="DestNode.Name" Caption="Remote Node" Sortable="false" Displayable="true"/>
            <DataGridColumn TItem="ChannelOperationRequest" Field="Wallet.Name" Caption="Source of Funds" Sortable="false" Displayable="true"/>
            <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.Amount)" Caption="Capacity" Sortable="false" Displayable="true">
                <DisplayTemplate>
                    @{
                        @($"{context.Amount} BTC")
                    }
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.WalletId)" Caption="Signatures Collected" Sortable="false" Displayable="true">
                <DisplayTemplate>
                    @{
                        if (context.RequestType == OperationRequestType.Open)
                        {
                            var signaturesCollected = context.NumberOfSignaturesCollected + 1;
                            var signaturesRequired = context.Wallet?.MofN ?? 0;
                            @($"{signaturesCollected} out of {signaturesRequired}")
                        }
                        else
                        {
                            @("N/A")
                        }
                    }
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.Status).Humanize(LetterCasing.Sentence)" Caption="Status" Sortable="false" Displayable="true">
                <DisplayTemplate>
                    @context?.Status.Humanize()
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridCommandColumn TItem="ChannelOperationRequest" Caption="Actions" Displayable="true">
                <NewCommandTemplate>
                    <Button Color="Color.Primary" hidden></Button>
                </NewCommandTemplate>
                <EditCommandTemplate>
                    <Button Color="Color.Primary" hidden=@_hideApprove Clicked="@(() => ShowModal(context.Item))">Approve</Button>
                    <Button Color="Color.Danger" Clicked="@(() => OpenModalForRejectOrCancelRequest(context.Item, ChannelOperationRequestStatus.Rejected))">Reject</Button>
                </EditCommandTemplate>
                <DeleteCommandTemplate>
                    <Button Color="Color.Primary" hidden></Button>
                </DeleteCommandTemplate>
            </DataGridCommandColumn>
        </ChildContent>
        <EmptyTemplate>
            <div class="box">
                No records were found.
            </div>
        </EmptyTemplate>
        <LoadingTemplate>
            <div class="box">
                <progress class="progress is-small is-primary" max="100"></progress>
            </div>
        </LoadingTemplate>
    </DataGrid>
}
<br />
<br />
<h3>All Requests</h3>
<br />
<DataGrid TItem="ChannelOperationRequest"
          Data="@_allRequests"
          Filterable="true"
          ShowPager="true"
          ShowPageSizes="true"
          Striped="true">
    <ChildContent>
        <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.Id)" Caption="#" Sortable="false" Displayable="true"/>
        <DataGridColumn TItem="ChannelOperationRequest" Filterable="false" Caption="Actions" Sortable="false" Displayable="true">
            <DisplayTemplate>
                @if (_showCancelButton && IsStatusCancellable(context.Status))
                {
                    <Button Color="Color.Secondary" Clicked="@(() => OpenModalForRejectOrCancelRequest(context, ChannelOperationRequestStatus.Cancelled))">Cancel</Button>
                }
            </DisplayTemplate>
        </DataGridColumn> 
        <DataGridColumn TItem="ChannelOperationRequest" Field="SourceNode.Name" Caption="Source Node" Sortable="false" Displayable="true"/>
        <DataGridColumn TItem="ChannelOperationRequest" Field="DestNode.Name" Caption="Remote Node" Sortable="false" Displayable="true"/>
        <DataGridColumn TItem="ChannelOperationRequest" Field="Wallet.Name" Caption="Source of Funds" Sortable="false" Displayable="true"/>
        <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.Amount)" Caption="Capacity" Sortable="false" Displayable="true">
            <DisplayTemplate>
                @{
                    @($"{context.Amount} BTC")
                }
            </DisplayTemplate>
        </DataGridColumn>
        <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.WalletId)" Caption="Signatures Collected" Sortable="false" Displayable="true">
            <DisplayTemplate>
                @{
                    if (context.RequestType == OperationRequestType.Open)
                    {
                        var signaturesCollected = context.NumberOfSignaturesCollected + 1;
                        var signaturesRequired = context.Wallet?.MofN ?? 0;
                        @($"{signaturesCollected} out of {signaturesRequired}")
                    }
                    else
                    {
                        @("N/A");
                    }
                }
            </DisplayTemplate>
        </DataGridColumn>
        <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.Status).Humanize(LetterCasing.Sentence)" Caption="Status" Sortable="false" Displayable="true"/>
        <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.CreationDatetime)" Caption="Creation Date" Sortable="true">
            <DisplayTemplate>
                @context.CreationDatetime.Humanize()
            </DisplayTemplate>
        </DataGridColumn>
        <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.UpdateDatetime)" Caption="Update date" Sortable="true">
            <DisplayTemplate>
                @context.UpdateDatetime.Humanize()
            </DisplayTemplate>
        </DataGridColumn>
        <DataGridColumn TItem="ChannelOperationRequest" Field="@nameof(ChannelOperationRequest.TxId)" Caption="Links" Sortable="false" Displayable="true">
            <DisplayTemplate>
                @if (mempoolUrl != null && !context.TxId.IsNullOrEmpty())
                {
                    <a href="@(mempoolUrl + "/tx/" + context.TxId)" target="_blank">See in Mempool</a>
                }
            </DisplayTemplate>
        </DataGridColumn>
    </ChildContent>
    <EmptyTemplate>
        <div class="box">
            No records were found.
        </div>
    </EmptyTemplate>
    <LoadingTemplate>
        <div class="box">
            <progress class="progress is-small is-primary" max="100"></progress>
        </div>
    </LoadingTemplate>
</DataGrid>
<PSBTSign @ref="_psbtSignRef" ApproveRequestDelegate="async ()=> await ApproveRequest()"  SigHashMode="SigHash.None"RequestId="_selectedRequest?.Id" TemplatePsbtString="@_templatePSBTString" SignedPSBT="@_psbt"></PSBTSign>
<Modal @bind-Visible="@_rejectCancelModalVisible">

    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>@_selectedStatusActionString operation: @_selectedRequest?.Id</ModalTitle>
            <CloseButton/>
        </ModalHeader>
        <ModalBody>
            <Fields Flex="Flex.JustifyContent.Center">
                <Field>
                    <Validation @ref="_reasonValidation" Validator="@(_selectedStatus == ChannelOperationRequestStatus.Rejected ? ValidationRule.IsNotEmpty : ValidationRule.None)">
                        <FieldLabel>Please type a reason before performing this operation</FieldLabel>
                        <MemoEdit Rows="4" @bind-Text="@_cancelOrRejectReason">
                            <ValidationError/>
                        </MemoEdit>
                    </Validation>
                </Field>
            </Fields>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" Clicked="@HideRejectOrCancelModal">Cancel</Button>
            <Button Disabled="@(_reasonValidation?.Validate() == ValidationStatus.Error)" Color="Color.Primary" Clicked="@RejectOrCancelRequest">
                Submit
            </Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@inject IChannelOperationRequestRepository ChannelOperationRequestRepository
@inject IChannelOperationRequestPSBTRepository ChannelOperationRequestPsbtRepository
@inject IToastService ToastService
@inject ILightningService LightningService
@inject IBackgroundJobClient  BackgroundJobClient

@code {
    private List<ChannelOperationRequest>? _channelRequests;
    private List<ChannelOperationRequest>? _allRequests;
    private ChannelOperationRequest? _selectedRequest;
    private ChannelOperationRequestStatus _selectedStatus;
    private bool _hideApprove;
    private bool _showRejectButton;
    private bool _showCancelButton;
    private bool _hidePendingRequests;
    private bool _modalVisible;
    private bool _rejectCancelModalVisible;
    private string? _psbt;
    private string? _templatePSBTString;
    private string? _cancelOrRejectReason;
    private string? _selectedStatusActionString;
    private bool _isSignedPSBTInvalid = true;
    private Validation? _reasonValidation;

    private string? mempoolUrl = Environment.GetEnvironmentVariable("MEMPOOL_ENDPOINT");

    private PSBTSign? _psbtSignRef;

    [CascadingParameter]
    private ApplicationUser? LoggedUser { get; set; }

    [CascadingParameter]
    private ClaimsPrincipal? ClaimsPrincipal {get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        if (LoggedUser != null)
        {
            await FetchRequests();
            if (ClaimsPrincipal != null && !ClaimsPrincipal.IsInRole(ApplicationUserRole.FinanceManager.ToString()))
            {
                _hideApprove = true;
                _showCancelButton = true;
                _hidePendingRequests = true;
            }
            else
            {
                _showRejectButton = true;
            }
        }
    }

    private async Task FetchRequests()
    {
        if (LoggedUser != null)
        {
            _allRequests = await ChannelOperationRequestRepository.GetAll();

            if (ClaimsPrincipal != null && ClaimsPrincipal.IsInRole(ApplicationUserRole.FinanceManager.ToString()))
            {
                _channelRequests = await ChannelOperationRequestRepository.GetUnsignedPendingRequestsByUser(LoggedUser.Id);
                _allRequests = _allRequests.Except(_channelRequests).ToList();
            }
        }
    }
    
    private static bool RequestPendingFilter(ChannelOperationRequest req)
    {
        return req.Status.Equals(ChannelOperationRequestStatus.Pending) || req.Status == ChannelOperationRequestStatus.PSBTSignaturesPending;
    }

    private void OpenModalForRejectOrCancelRequest(ChannelOperationRequest req, ChannelOperationRequestStatus status)
    {
        _selectedRequest = req;
        _selectedStatus = status;
        _rejectCancelModalVisible = true;
        switch(_selectedStatus)
        {
            case ChannelOperationRequestStatus.Rejected: _selectedStatusActionString = "Reject"; break;
            case ChannelOperationRequestStatus.Cancelled: _selectedStatusActionString = "Cancel"; break;
        }
    }

    private async Task RejectOrCancelRequest()
    {
        if (_selectedRequest != null)
        {
            _selectedRequest.ClosingReason = _cancelOrRejectReason;
            _selectedRequest.Status = _selectedStatus;
            var jobUpdateResult = ChannelOperationRequestRepository.Update(_selectedRequest);
            if (!jobUpdateResult.Item1)
            {
                ToastService.ShowError("There has been an error when updating the request");
            }
            else
            {
                ToastService.ShowSuccess("Request " + _selectedStatus);
                await FetchRequests();
            }
        }
        else
        {
            ToastService.ShowError("Couldn't fetch data from the request");
        }
        _rejectCancelModalVisible = false;
    }
    
    private async Task ShowModal(ChannelOperationRequest channelOperationRequest)
    {
        _selectedRequest = channelOperationRequest;
        _psbt = string.Empty;
        if (_selectedRequest != null && !_selectedRequest.AreAllRequiredSignaturesCollected) {
            var (templatePsbt,noUtxosAvailable) = (await LightningService.GenerateTemplatePSBT(_selectedRequest));
            if (templatePsbt != null)
            {
                _templatePSBTString = templatePsbt.ToBase64();
                await _psbtSignRef.ShowModal();

            }
            else
            {
                if (noUtxosAvailable)
                {
                    ToastService.ShowError("No UTXOs found for this wallet, please wait for other requests to be confirmed or fund the wallet with more UTXOs");

                }
                else
                {
                    ToastService.ShowError("Something went wrong");

                }
            }
            
        }
    }

    private void HideRejectOrCancelModal()
    {
        _rejectCancelModalVisible = false;
        _cancelOrRejectReason = null;

    }


    private async Task ApproveRequest()
    {
        _psbtSignRef?.HideModal();

        if (_selectedRequest == null || string.IsNullOrEmpty(_psbtSignRef.SignedPSBT) || LoggedUser == null)
        {
            ToastService.ShowError("Error: Not all fields were set");
        }
        else {
            ChannelOperationRequestPSBT channelOperationRequestPsbt = new()
            {
                ChannelOperationRequestId = _selectedRequest.Id,
                PSBT = _psbtSignRef.SignedPSBT,
                UserSignerId = LoggedUser.Id,
                
            };
            var addResult = await ChannelOperationRequestPsbtRepository.AddAsync(channelOperationRequestPsbt);

            if (addResult.Item1)
            {
                ToastService.ShowSuccess("Signature collected");

                _selectedRequest = await ChannelOperationRequestRepository.GetById(_selectedRequest.Id);

                if (_selectedRequest != null 
                    && _selectedRequest.AreAllRequiredSignaturesCollected)
                {
                    var failedOpenChannelRequest = false;
                    try
                    {  
                       //TODO Async notifications when the channel has opened -> event / notifications system
                        var jobId = BackgroundJobClient.Enqueue<ILightningService>(service => 
                            service.OpenChannel(_selectedRequest));

                        _selectedRequest.JobId = jobId;

                        var jobUpdateResult = ChannelOperationRequestRepository.Update(_selectedRequest);
                    }
                    catch
                    {
                        failedOpenChannelRequest = true;
                    }

                    if (failedOpenChannelRequest)
                    {
                        ToastService.ShowError("Error while requesting to open the channel, please contact a superadmin for troubleshooting");

                    }
                    else
                    {
                        ToastService.ShowSuccess("Channel opening job created");
                    }

                }
                else
                {
                    ToastService.ShowError("Invalid PSBT");

                }
            }
            else
            {
                ToastService.ShowSuccess("Error while saving the signature");

            }
        
            await FetchRequests();
            await _psbtSignRef.HideModal();

        }
        
      
    }

  
    
    private bool IsStatusCancellable(ChannelOperationRequestStatus status)
    {
        return status is ChannelOperationRequestStatus.Pending
            or ChannelOperationRequestStatus.Approved;
    }

   
}