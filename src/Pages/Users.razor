@using Humanizer
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using System.Threading
@using Blazorise.Extensions
@using Blazorise
@using Blazorise.DataGrid
@using Microsoft.AspNetCore.Components.Web
<PageTitle>User Management</PageTitle>
<h3 class="custom-primary">User and role management</h3>

<Row>
    <Column ColumnSize="ColumnSize.Is12">
        <DataGrid TItem="ApplicationUser"
                  @ref="_usersDataGrid"
                  Data="@_users"
                  ReadData="@OnReadData"
                  TotalItems="@_totalItems"
                  Editable="true"
                  EditMode="DataGridEditMode.Popup"
                  Responsive="true"
                  ResizeMode="TableResizeMode.Columns"
                  UseInternalEditing="true"
                  RowInserted="OnRowInserted"
                  RowRemoving="OnRowRemoving"
                  RowUpdated="OnRowUpdated"
                  NewItemDefaultSetter="NewItemDefaultSetter"
                  ShowPager="true"
                  ShowPageSizes="true"
                  PageSize="25"
                  Filterable="false"
                  ShowValidationFeedback="true"
                  ShowValidationsSummary="false"
                  UseValidation="true">
            <PopupTitleTemplate>
                <h2>@(context.EditState) user</h2>
            </PopupTitleTemplate>
            <DataGridColumns>
                <DataGridCommandColumn TItem="ApplicationUser" Filterable="false">
                    <NewCommandTemplate>
                        <Button Color="Color.Success" TextColor="TextColor.Light" Clicked="@context.Clicked">New</Button>
                    </NewCommandTemplate>
                    <EditCommandTemplate>
                        <Buttons>
                            <Button Color="Color.Primary" Clicked="@(()=>OnEditInvoked(context.Item,context.Clicked))">Edit</Button>
                            <Button Color="Color.Primary" Clicked="@(()=>OnResetLinkClicked(context.Item))">Set password link</Button>
                            @if (context.Item.IsLocked)
                            {
                                <Button Color="Color.Danger" Clicked="@(()=>OnUnlockUserClicked(context.Item))">Unlock</Button>
                            }
                            else
                            {
                                <Button Color="Color.Danger" Clicked="@(()=>OnLockUserClicked(context.Item))">Lock</Button>
                            }
                        </Buttons>
                    </EditCommandTemplate>
                    <DeleteCommandTemplate>
                        @*Button Color="Color.Danger" Clicked="@context.Clicked">Delete</Button>*@
                    </DeleteCommandTemplate>
                </DataGridCommandColumn>
                <DataGridColumn TItem="ApplicationUser" Editable="true" Field="@nameof(ApplicationUser.UserName)" Caption="Username" Sortable="false" Displayable="@IsColumnVisible(UsersColumnName.Username)" Filterable="false">
                    <EditTemplate>
                        <Validation AsyncValidator="(args, token) => ValidateUsernameAsync(args, token, context.Item.Id)">
                            <TextEdit Text="@((string)context.CellValue)" TextChanged="(text) => { context.CellValue = text; }">
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </TextEdit>
                        </Validation>
                    </EditTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="ApplicationUser" Editable="true"  Caption="Roles" Sortable="false" Displayable="@IsColumnVisible(UsersColumnName.Roles)" Filterable="false">
                    <DisplayTemplate>
                        @{
                            <span>@(GetUserRolesString(context))</span>
                        }
                    </DisplayTemplate>
                    <EditTemplate>
                        <Validation Validator="@ValidateRole">
                            <Select Multiple="true" TValue="ApplicationUserRole" @bind-SelectedValues="_selectedRoles" SelectedValueChanged="(role) => { context.CellValue = role; }">
                                <ChildContent>
                                    @foreach (var role in availableRoles)
                                    {
                                        <SelectItem Value="role">@role.Humanize()</SelectItem>
                                    }
                                </ChildContent>
                                <Feedback>
                                    <ValidationError/>
                                </Feedback>
                            </Select>
                        </Validation>
                    </EditTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="ApplicationUser" Editable="true" Field="@nameof(ApplicationUser.Nodes)" Caption="Managed nodes" Sortable="false" Displayable="@IsColumnVisible(UsersColumnName.ManagedNodes)" Filterable="false">
                    <DisplayTemplate>
                        @{
                            <span>@context?.Nodes?.Select(x=> x.Name).Humanize()</span>
                        }
                    </DisplayTemplate>
                    <EditTemplate>
                        <Select Multiple="true" TValue="int" @bind-SelectedValues="_selectedManagedNodes">
                            @foreach (var node in _nodesList)
                            {
                                <SelectItem Value="node.Id">@node.Name</SelectItem>
                            }
                        </Select>
                    </EditTemplate>
                </DataGridColumn>
                <DataGridColumn TItem="ApplicationUser" Displayable="true">
                    <FilterTemplate>
                        <ColumnLayout @ref="UsersColumnLayout" Columns="@UsersColumns" ColumnType="UsersColumnName" OnUpdate="@OnColumnLayoutUpdate"/>
                    </FilterTemplate>
                </DataGridColumn>
            </DataGridColumns>
        </DataGrid>
    </Column>
</Row>

@page "/users"
@inject IApplicationUserRepository ApplicationUserRepository
@inject IToastService ToastService
@inject INodeRepository NodeRepository
@inject ILocalStorageService LocalStorageService
@inject IAuditService AuditService
@attribute [Authorize(Roles = "Superadmin")]
@code {
    private List<ApplicationUser> _users = new();
    private DataGrid<ApplicationUser>? _usersDataGrid;
    private int _totalItems;

    [CascadingParameter]
    private ApplicationUser? LoggedUser { get; set; }

    [CascadingParameter]
    private ClaimsPrincipal? ClaimsPrincipal { get; set; }

    private IReadOnlyList<ApplicationUserRole> _selectedRoles = new List<ApplicationUserRole> {};

    private List<ApplicationUserRole> availableRoles = Enum.GetValues(typeof(ApplicationUserRole)).Cast<ApplicationUserRole>().ToList();

    private List<Node> _nodesList = new();

    private IReadOnlyList<int> _selectedManagedNodes = new List<int> {};

    private ColumnLayout<UsersColumnName> UsersColumnLayout;
    private Dictionary<string, bool> UsersColumns = new();
    private bool columnsLoaded;

    public abstract class UsersColumnName
    {
        public static readonly ColumnDefault Username = new("Username");
        public static readonly ColumnDefault Roles = new("Roles");
        public static readonly ColumnDefault ManagedNodes = new("Managed Nodes");
    }

    protected override async Task OnInitializedAsync()
    {
        if (LoggedUser != null)
        {
            await LoadNodesList();
        }
    }

    private async Task LoadNodesList()
    {
        _nodesList = await NodeRepository.GetAllManagedByNodeGuard();
    }

    private async Task OnReadData(DataGridReadDataEventArgs<ApplicationUser> e)
    {
        if (LoggedUser == null) return;

        var (users, totalCount) = await ApplicationUserRepository.GetPaginatedAsync(
            e.Page,
            e.PageSize,
            includeBanned: true);

        _users = users;
        _totalItems = totalCount;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender && !columnsLoaded)
        {
            await LoadColumnLayout();

        }
    }

    private async Task LoadColumnLayout()
    {
        UsersColumns = await LocalStorageService.LoadStorage(nameof(UsersColumnName), ColumnHelpers.GetColumnsDictionary<UsersColumnName>());
        columnsLoaded = true;
        StateHasChanged();
    }

    private async Task OnRowInserted(SavedRowItem<ApplicationUser, Dictionary<string, object>> arg)
    {
        if (arg.Item == null) return;

        if (!_selectedRoles.Any())
        {
            ToastService.ShowError("Please select at least one role for the user.");
            _users.Remove(arg.Item);
            return;
        }

        var addResult = await ApplicationUserRepository.AddAsync(arg.Item);

        if (addResult.Item1)
        {
            //Nodes
            arg.Item.Nodes = new List<Node>();
            foreach (var selectedManagedNode in _selectedManagedNodes)
            {
                var node= await NodeRepository.GetById(selectedManagedNode);
                node = Mapper.Map<Node, Node>(node);
                arg.Item.Nodes.Add(node);
            }


            var updateResult = ApplicationUserRepository.Update(arg.Item);

            //Roles
            var updateUserRoles = await ApplicationUserRepository.UpdateUserRoles(_selectedRoles,arg.Item);
            if (updateResult.Item1 && updateUserRoles.Item1)
            {
                ToastService.ShowSuccess("Success");
                await AuditService.LogAsync(
                    AuditActionType.Create,
                    AuditEventType.Success,
                    AuditObjectType.User,
                    arg.Item.Id,
                    new { Username = arg.Item.UserName, Roles = string.Join(", ", _selectedRoles) });
                if (_usersDataGrid != null)
                {
                    await _usersDataGrid.Reload();
                }
            }
            else
            {
                ToastService.ShowError("Something went wrong");
                _users.Remove(arg.Item);
                await AuditService.LogAsync(
                    AuditActionType.Create,
                    AuditEventType.Failure,
                    AuditObjectType.User,
                    null,
                    new { Username = arg.Item.UserName });
            }

        }

        else
        {
            ToastService.ShowError("Something went wrong");
            _users.Remove(arg.Item);

        }
    }

    private async Task OnRowRemoving(CancellableRowChange<ApplicationUser> arg)
    {
        if (arg.Item != null)
        {

            var (result, message) = ApplicationUserRepository.Remove(arg.Item);

            if (!result)
            {

                arg.Cancel = true;
                ToastService.ShowError("Something went wrong");
            }
            else
            {
                ToastService.ShowSuccess("Success");
                if (_usersDataGrid != null)
                {
                    await _usersDataGrid.Reload();
                }
            }
        }
    }

    private async Task OnRowUpdated(SavedRowItem<ApplicationUser, Dictionary<string, object>> arg)
    {
        if (arg.Item == null) return;
        //nodes

        var clearResult = await ApplicationUserRepository.ClearNodes(arg.Item);

        foreach (var selectedManagedNode in _selectedManagedNodes)
        {
            var node= await NodeRepository.GetById(selectedManagedNode);

            node = Mapper.Map<Node, Node>(node);

            arg.Item.Nodes.Add(node);
        }


        var updateResult2 = ApplicationUserRepository.Update(arg.Item);

        //Roles
        var updateUserRoles = await ApplicationUserRepository.UpdateUserRoles(_selectedRoles,arg.Item);

        if (updateResult2.Item1 && clearResult.Item1 && updateUserRoles.Item1)
        {
            ToastService.ShowSuccess("Success");
            await AuditService.LogAsync(
                AuditActionType.Update,
                AuditEventType.Success,
                AuditObjectType.User,
                arg.Item.Id,
                new { Username = arg.Item.UserName, Roles = string.Join(", ", _selectedRoles) });
        }
        else
        {
            ToastService.ShowError("Something went wrong");
            await AuditService.LogAsync(
                AuditActionType.Update,
                AuditEventType.Failure,
                AuditObjectType.User,
                arg.Item.Id,
                new { Username = arg.Item.UserName });
        }

        if (_usersDataGrid != null)
        {
            await _usersDataGrid.Reload();
        }
    }

    private void NewItemDefaultSetter(ApplicationUser obj)
    {
        obj.EmailConfirmed = true;
        _selectedRoles = new List<ApplicationUserRole>();
        _selectedManagedNodes = new List<int>();
    }


    private string GetUserRolesString(ApplicationUser context)
    {
        var result = string.Empty;
        if (context != null)
        {
            result  = ApplicationUserRepository.GetUserRoles(context).Humanize();
        }

        return result;
    }


    private async Task OnEditInvoked(ApplicationUser user, EventCallback contextClicked)
    {
        var userRoles = ApplicationUserRepository.GetUserRoles(user) ;
        _selectedRoles = userRoles;

        _selectedManagedNodes = new List<int>(user.Nodes.Select(x => x.Id));

        await contextClicked.InvokeAsync();
    }

    private async Task CopyStrToClipboard(string arg)
    {
        await ClipboardService.WriteTextAsync(arg);
        ToastService.ShowSuccess("Text copied");
    }

    private async Task OnResetLinkClicked(ApplicationUser contextItem)
    {
        var link = await ApplicationUserRepository.GetUserPasswordMagicLink(contextItem);

        if (link != null)
        {
            await ClipboardService.WriteTextAsync(link);
            ToastService.ShowSuccess("Text copied");
        }
        else
        {
            ToastService.ShowError("Something went wrong");

        }

    }

    private async Task OnUnlockUserClicked(ApplicationUser contextItem)
    {
        if (contextItem != null)
        {
          var lockResult= await
            ApplicationUserRepository.UnlockUser(contextItem);

            if (lockResult.Item1)
            {
                ToastService.ShowSuccess("User unlocked");
                await AuditService.LogAsync(
                    AuditActionType.UnlockUser,
                    AuditEventType.Success,
                    AuditObjectType.User,
                    contextItem.Id,
                    new { Username = contextItem.UserName });
            }
            else
            {
                ToastService.ShowError("Something went wrong");
                await AuditService.LogAsync(
                    AuditActionType.UnlockUser,
                    AuditEventType.Failure,
                    AuditObjectType.User,
                    contextItem.Id,
                    new { Username = contextItem.UserName });
            }

            if (_usersDataGrid != null)
            {
                await _usersDataGrid.Reload();
            }
        }
    }

    private async Task OnLockUserClicked(ApplicationUser contextItem)
    {
        if (contextItem != null)
        {
            var lockResult= await
                ApplicationUserRepository.LockUser(contextItem);

            if (lockResult.Item1)
            {
                ToastService.ShowSuccess("User locked out");
                await AuditService.LogAsync(
                    AuditActionType.LockUser,
                    AuditEventType.Success,
                    AuditObjectType.User,
                    contextItem.Id,
                    new { Username = contextItem.UserName });
            }
            else
            {
                ToastService.ShowError("Something went wrong");
                await AuditService.LogAsync(
                    AuditActionType.LockUser,
                    AuditEventType.Failure,
                    AuditObjectType.User,
                    contextItem.Id,
                    new { Username = contextItem.UserName });
            }

            if (_usersDataGrid != null)
            {
                await _usersDataGrid.Reload();
            }
        }
    }

    private async Task ValidateUsernameAsync(ValidatorEventArgs obj, CancellationToken cancellationToken, string currentUserId)
    {
        obj.Status = ValidationStatus.Success;
        if (string.IsNullOrWhiteSpace((string)obj.Value))
        {
            obj.ErrorText = "The Username cannot be empty";
            obj.Status = ValidationStatus.Error;
            return;
        }

        var existingUser = await ApplicationUserRepository.GetByUsername(obj.Value.ToString());
        if (existingUser != null && existingUser.Id != currentUserId)
        {
            obj.ErrorText = "A user with the same username already exists";
            obj.Status = ValidationStatus.Error;
        }
    }

    private void ValidateRole(ValidatorEventArgs obj)
    {
        obj.Status = ValidationStatus.Success;
        if (((IReadOnlyList<ApplicationUserRole>)obj.Value).IsNullOrEmpty())
        {
            obj.ErrorText = "At least one role must be selected";
            obj.Status = ValidationStatus.Error;
        }
    }

    private void OnColumnLayoutUpdate()
    {
        StateHasChanged();
    }

    private bool IsColumnVisible(ColumnDefault column)
    {
        if (UsersColumnLayout	== null)
        {
            return true;
        }
        return UsersColumnLayout.IsColumnVisible(column);
    }
}
